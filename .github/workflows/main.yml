name: iOS-ipa-build

on:
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest  # Use macOS runner

    steps:
      # Checkout the repository
      - uses: actions/checkout@v3

      # Setup Flutter environment
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # You can specify a version here if needed
          architecture: arm64  # Let Flutter decide, or use `x64` if targeting Intel Macs

      # Install Flutter dependencies
      - run: flutter pub get

      # Install CocoaPods dependencies
      - run: pod install --repo-update
        working-directory: ios  # Ensure to work inside the iOS directory

      # Build iOS app in release mode without code-signing
      - run: flutter build ios --release --no-codesign

      # Create Payload directory for .ipa packaging
      - run: mkdir -p build/ios/iphoneos/Payload

      # Move the Runner.app into Payload directory (Make sure the path is correct)
      - run: mv build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/

      # Zip the .app into a .ipa file
      - name: Zip output into .ipa
        run: zip -qq -r -9 build/ios/iphoneos/FlutterIpaExport.ipa build/ios/iphoneos/Payload

      # Create a release if it doesn't exist using GitHub API
      - name: Create Release
        id: create_release
        uses: actions/github-script@v6
        with:
          script: |
            const tagName = 'v1.0';  // Tag name for the release
            const releaseName = 'Release v1.0';  // Name of the release
            const releaseBody = 'This is the first release of the iOS app.';  // Release notes
            
            // Check if the release already exists
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tagName
            }).catch(() => null);  // If it doesn't exist, we catch the error
            
            if (!release) {
              // If release doesn't exist, create it
              const response = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: releaseBody,
                draft: false,
                prerelease: false
              });
              console.log(`Release created: ${response.data.html_url}`);
            } else {
              console.log(`Release already exists: ${release.html_url}`);
            }
        
      # Upload the .ipa to GitHub Releases
      - name: Upload .ipa to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}  # GitHub token for authentication
          file: build/ios/iphoneos/FlutterIpaExport.ipa  # The .ipa file to upload
          tag: v1.0  # Tag for the release
          overwrite: true  # Overwrite if the file already exists in the release
          body: "This is the first release of the iOS app."  # Optional release body description
