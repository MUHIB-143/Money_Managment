name: iOS-ipa-build

on:
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest  # Use macOS runner

    steps:
      # Checkout the repository
      - uses: actions/checkout@v3

      # Setup Flutter environment
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # You can specify a version here if needed
          architecture: arm64  # Let Flutter decide, or use `x64` if targeting Intel Macs

      # Install Flutter dependencies
      - run: flutter pub get

      # Install CocoaPods dependencies
      - run: pod install --repo-update
        working-directory: ios  # Ensure to work inside the iOS directory

      # Build iOS app in release mode without code-signing
      - run: flutter build ios --release --no-codesign

      # Create Payload directory for .ipa packaging
      - run: mkdir -p build/ios/iphoneos/Payload

      # Move the Runner.app into Payload directory (Make sure the path is correct)
      - run: mv build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/

      # Zip the .app into a .ipa file
      - name: Zip output into .ipa
        run: zip -qq -r -9 build/ios/iphoneos/FlutterIpaExport.ipa build/ios/iphoneos/Payload

      # Create a new release if it doesn't exist
      - name: Create Release
        id: create_release
        uses: gh-action-create-release@v1  # Action to create a release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v1.0  # Set the version tag you want
          release_name: "Release v1.0"  # Set the name of the release
          body: "This is the first release of the iOS app."

      # Upload the .ipa to GitHub Releases
      - name: Upload .ipa to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}  # GitHub token for authentication
          file: build/ios/iphoneos/FlutterIpaExport.ipa  # The .ipa file to upload
          tag: v1.0  # Tag for the release
          overwrite: true  # Overwrite if the file already exists in the release
          body: "This is the first release of the iOS app."  # Optional release body description
